name: Pikafish-WASM

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  workflow_dispatch:

jobs:
  Pikafish-WASM:
    name: WebAssembly Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: '3.1.71'
          actions-cache-folder: 'emsdk-cache'

      - name: Verify Emscripten installation
        run: |
          emcc --version
          em++ --version

      - name: Download NNUE network file
        run: |
          cd src
          wget -O pikafish.nnue https://github.com/official-pikafish/Networks/releases/download/master-net/pikafish.nnue
          ls -lh pikafish.nnue

      - name: Verify WASM wrapper exists
        run: |
          ls -lh src/wasm_api.cpp
          echo "WASM API wrapper is ready"

      - name: Build WASM (SIMD version)
        run: |
          cd src

          # Get list of source files
          SOURCES=$(find . -name "*.cpp" -not -name "main.cpp" | tr '\n' ' ')

          # Build with Emscripten
          em++ -std=c++20 \
            -O3 \
            -msimd128 \
            -msse -msse2 -msse3 -mssse3 -msse4.1 \
            -DUSE_SSE41 \
            -DUSE_SSSE3 \
            -DUSE_SSE2 \
            -DNDEBUG \
            --bind \
            -s WASM=1 \
            -s ALLOW_MEMORY_GROWTH=1 \
            -s INITIAL_MEMORY=256MB \
            -s MAXIMUM_MEMORY=2GB \
            -s EXPORT_ES6=1 \
            -s MODULARIZE=1 \
            -s EXPORT_NAME="createPikafishModule" \
            -s ENVIRONMENT=web,worker \
            -s ASSERTIONS=0 \
            -s DISABLE_EXCEPTION_CATCHING=0 \
            --embed-file pikafish.nnue@/pikafish.nnue \
            -o pikafish-simd.js \
            $SOURCES

          ls -lh pikafish-simd.*

      - name: Build WASM (Basic version - no SIMD)
        run: |
          cd src

          # Get list of source files
          SOURCES=$(find . -name "*.cpp" -not -name "main.cpp" | tr '\n' ' ')

          # Build basic version without SIMD for compatibility
          em++ -std=c++20 \
            -O3 \
            -DNDEBUG \
            --bind \
            -s WASM=1 \
            -s ALLOW_MEMORY_GROWTH=1 \
            -s INITIAL_MEMORY=256MB \
            -s MAXIMUM_MEMORY=2GB \
            -s EXPORT_ES6=1 \
            -s MODULARIZE=1 \
            -s EXPORT_NAME="createPikafishModule" \
            -s ENVIRONMENT=web,worker \
            -s ASSERTIONS=0 \
            -s DISABLE_EXCEPTION_CATCHING=0 \
            --embed-file pikafish.nnue@/pikafish.nnue \
            -o pikafish-basic.js \
            $SOURCES

          ls -lh pikafish-basic.*

      - name: Create JavaScript wrapper
        run: |
          cat > pikafish-wrapper.js << 'EOF'
          /**
           * Pikafish WebAssembly Wrapper
           * Provides a high-level API for using Pikafish in web applications
           */

          export class PikafishEngine {
            constructor() {
              this.module = null;
              this.engine = null;
              this.ready = false;
            }

            async init(modulePath = './pikafish-simd.js') {
              try {
                // Dynamically import the WASM module
                const createModule = (await import(modulePath)).default;
                this.module = await createModule();
                this.engine = new this.module.PikafishWASM();
                this.engine.init();
                this.ready = true;
                return this.getVersion();
              } catch (error) {
                console.error('Failed to initialize Pikafish:', error);
                throw error;
              }
            }

            setPosition(fen) {
              if (!this.ready) throw new Error('Engine not initialized');
              return this.engine.setPosition(fen);
            }

            async getBestMove(depth = 20) {
              if (!this.ready) throw new Error('Engine not initialized');
              return this.engine.go(depth);
            }

            stop() {
              if (!this.ready) throw new Error('Engine not initialized');
              return this.engine.stop();
            }

            getVersion() {
              if (!this.ready) throw new Error('Engine not initialized');
              return this.engine.getVersion();
            }

            async analyze(fen, depth = 20) {
              this.setPosition(fen);
              return await this.getBestMove(depth);
            }
          }

          // For non-module environments
          if (typeof window !== 'undefined') {
            window.PikafishEngine = PikafishEngine;
          }
          EOF

      - name: Create TypeScript definitions
        run: |
          cat > pikafish-wrapper.d.ts << 'EOF'
          /**
           * Pikafish WebAssembly TypeScript Definitions
           */

          export class PikafishEngine {
            constructor();

            /**
             * Initialize the engine
             * @param modulePath - Path to the WASM module (default: './pikafish-simd.js')
             * @returns Engine version string
             */
            init(modulePath?: string): Promise<string>;

            /**
             * Set the board position using FEN notation
             * @param fen - FEN string representing the board position
             */
            setPosition(fen: string): void;

            /**
             * Get the best move for the current position
             * @param depth - Search depth (default: 20)
             * @returns Best move in UCI format
             */
            getBestMove(depth?: number): Promise<string>;

            /**
             * Stop the current search
             */
            stop(): void;

            /**
             * Get engine version information
             * @returns Version string
             */
            getVersion(): string;

            /**
             * Analyze a position and return the best move
             * @param fen - FEN string representing the board position
             * @param depth - Search depth (default: 20)
             * @returns Best move in UCI format
             */
            analyze(fen: string, depth?: number): Promise<string>;
          }
          EOF

      - name: Create README for WASM distribution
        run: |
          cat > WASM-README.md << 'EOF'
          # Pikafish WebAssembly Distribution

          This distribution contains Pikafish compiled to WebAssembly for use in web browsers.

          ## Files Included

          - `pikafish-simd.js` / `pikafish-simd.wasm` - SIMD-optimized version (faster, requires modern browser)
          - `pikafish-basic.js` / `pikafish-basic.wasm` - Basic version (wider compatibility)
          - `pikafish-wrapper.js` - High-level JavaScript API wrapper
          - `pikafish-wrapper.d.ts` - TypeScript type definitions

          ## Quick Start

          ```javascript
          import { PikafishEngine } from './pikafish-wrapper.js';

          const engine = new PikafishEngine();
          await engine.init('./pikafish-simd.js');

          // Analyze a position
          const fen = 'rnbakabnr/9/1c5c1/p1p1p1p1p/9/9/P1P1P1P1P/1C5C1/9/RNBAKABNR w - - 0 1';
          const bestMove = await engine.analyze(fen, 15);
          console.log('Best move:', bestMove);
          ```

          ## Browser Compatibility

          - **SIMD version**: Chrome 91+, Firefox 89+, Safari 16.4+, Edge 91+
          - **Basic version**: Any modern browser with WebAssembly support

          ## Usage in Web Extension

          1. Include the WASM files in your extension manifest
          2. Use the wrapper API to communicate with the engine
          3. Consider running in a Web Worker for better performance

          ## Network File

          The NNUE network file (`pikafish.nnue`) is embedded in the WASM binary.
          Total size: ~30-35MB including the network.

          ## License

          GPL-3.0 (same as Pikafish)
          EOF

      - name: Package WASM distribution
        run: |
          mkdir -p wasm-dist
          cp src/pikafish-simd.js src/pikafish-simd.wasm wasm-dist/ 2>/dev/null || true
          cp src/pikafish-basic.js src/pikafish-basic.wasm wasm-dist/ 2>/dev/null || true
          cp pikafish-wrapper.js pikafish-wrapper.d.ts WASM-README.md wasm-dist/
          cd wasm-dist
          ls -lh

      - name: Upload WASM artifact
        uses: actions/upload-artifact@v4
        with:
          name: Pikafish-WASM
          path: wasm-dist/

      - name: Upload to release (if tagged)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            wasm-dist/pikafish-simd.js
            wasm-dist/pikafish-simd.wasm
            wasm-dist/pikafish-basic.js
            wasm-dist/pikafish-basic.wasm
            wasm-dist/pikafish-wrapper.js
            wasm-dist/pikafish-wrapper.d.ts
            wasm-dist/WASM-README.md
